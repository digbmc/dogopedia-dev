---
layout: bilingual
---

{% assign thisChapter = site.texts | where: "chapter-number", page.number %}
{% assign thisChapter-en = thisChapter | where: "language", "en" %}
{% for i in thisChapter-en %}
{% assign title_en = i.title %}
{% assign text_en = i.content %}
{% endfor %}
{% assign thisChapter-ru = thisChapter | where: "language", "ru" %}
{% for i in thisChapter-ru %}
{% assign title_ru = i.title %}
{% assign text_ru = i.content %}
{% endfor %}

<article class="narrative bilingual annotations-hidden" id="chapter-content">
  <div class="header">
    <h1 class="text-title" id="en-title">{{ page.number }}. {{ title_en }}</h1>
    <h1 class="text-title" id="ru-title">{{ page.number }}. {{ title_ru }}</h1>
    <h1 class="text-title" id="both-title">{{ page.number }}. {{ title_en }} / {{ title_ru }}</h1>
    <p class="byline">by {{ page.author }}</p>
    <p class="byline" id="translator">Translated by {{ page.translator }}</p>
  </div>

  <div class="main-content">
    <div class="text-container english" id="texts">
      <div id="en" markdown="1">
        {% capture annotated-text-en %}
        {{ text_en }}
        {% endcapture %}

        {% capture chapter-title-en %}{% if page.number == "01" %}{{ page.number }}. DISCORDS BEYOND THE ITIL{% else %}{{ page.number }}. {{ title_en }}{% endif %}{% endcapture %}
        {% assign annotations-en = site.data.comments-all | where: "chapter", chapter-title-en %}
        {% for annotation in annotations-en %}
          {% capture highlighted %}{{ annotation.highlighted }}{% endcapture %}
          {% assign thisIndex = forloop.index %}
          {% assign nestedAnnos = "" %}
          {% assign overlappedAnnos = "" %}
          {% for nextAnno in annotations-en offset:thisIndex %}
            {% if nextAnno.position_start == annotation.position_start and nextAnno.position_end >= annotation.position_end %}
              {% assign nextIndex = forloop.index %}
              {% assign longerHighlighted = nextAnno.highlighted %}
              {% capture replaced-text %}{{ longerHighlighted }}{% endcapture %}
              {% capture new-text %}<span id="highlight-{{ nextAnno.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ nextAnno.Id }}';" tabindex="-1" aria-hidden="true">{{ longerHighlighted }}</span>{% endcapture %}
              {% capture annotated-text-en %}{{ annotated-text-en | replace_first: replaced-text, new-text }}{% endcapture %}
              {% assign highlighted = new-text %}
              {% for nextNextAnno in annotations-en offset:nextIndex %}
                {% if nextNextAnno.position_start <= nextAnno.position_end and nextNextAnno.position_end <= nextAnno.position_end %}
                  {% capture nextId %}{{ nextNextAnno.Id }}, {% endcapture %}
                  {% assign nestedAnnos = nestedAnnos | append: nextId %}
                {% elsif nextNextAnno.position_start < nextAnno.position_end %}
                  {% continue %}
                {% else %}
                  {% break %}
                {% endif %}
              {% endfor %}
              {% if nestedAnnos != "" %}
                {% assign nestedAnnos = nestedAnnos | split: ", " %}
                {% assign replaced-highlighted = highlighted %}
                {% for nestedAnno in nestedAnnos %}
                  {% assign thisNestedAnno = annotations-en | where: "Id", nestedAnno | first %}
                  {% capture new-highlighted %}<span id="highlight-{{ thisNestedAnno.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ thisNestedAnno.Id }}';" tabindex="-1" aria-hidden="true">{{ thisNestedAnno.highlighted }}</span>{% endcapture %}
                  {% capture replaced-highlighted %}{{ replaced-highlighted | replace_first: thisNestedAnno.highlighted, new-highlighted }}{% endcapture %}
                {% endfor %}
                {% capture replaced-text %}{{ highlighted }}{% endcapture %}
                {% capture new-text %}{{ replaced-highlighted }}{% endcapture %}
                {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
                {% capture annotated-text-en %}{{ annotated-text-en | replace_first: replaced-text, new-text }}{% endcapture %}
                {% endunless %}
              {% else %}
                {% capture suffix %}{{ annotation.suffix | newline_to_br | split: "<br />" | first | rstrip | truncate: 5, "" }}{% endcapture %}
                {% capture replaced-text %}{{ highlighted }}{{ suffix }}{% endcapture %}
                {% comment %}{{ replaced-text }}<br>{% endcomment %}
                {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
                {% capture new-text %}<span id="highlight-{{ annotation.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ annotation.Id }}';" tabindex="-1" aria-hidden="true">{{ annotation.highlighted }}</span>{{ suffix }}{% endcapture %}
                {% capture annotated-text-en %}{{ annotated-text-en | replace_first: replaced-text, new-text }}{% endcapture %}
                {% endunless %}
              {% endif %}
            {% elsif nextAnno.position_start <= annotation.position_end and nextAnno.position_end <= annotation.position_end %}
              {% capture nextId %}{{ nextAnno.Id }}, {% endcapture %}
              {% assign nestedAnnos = nestedAnnos | append: nextId %}
            {% elsif nextAnno.position_start < anno.position_end %}
               {% continue %}
            {% else %}
              {% break %}
            {% endif %}
          {% endfor %}
          {% if nestedAnnos != "" %}
            {% assign nestedAnnos = nestedAnnos | split: ", " %}
            {% for nestedAnno in nestedAnnos %}
              {% assign thisNestedAnno = annotations-en | where: "Id", nestedAnno | first %}
              {% assign replaced-text = thisNestedAnno.highlighted %}
              {% capture new-text %}<span id="highlight-{{ thisNestedAnno.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ thisNestedAnno.Id }}';" tabindex="-1" aria-hidden="true">{{ thisNestedAnno.highlighted }}</span>{% endcapture %}
              {% capture new-highlighted %}{{ highlighted | replace_first: replaced-text, new-text }}{% endcapture %}
            {% endfor %}
            {% capture suffix %}{{ annotation.suffix | newline_to_br | split: "<br />" | first | rstrip | truncate: 5, "" }}{% endcapture %}
            {% capture replaced-text %}{{ highlighted }}{{ suffix }}{% endcapture %}
            {% comment %}{{ replaced-text }}<br>{% endcomment %}
            {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
            {% capture new-text %}<span id="highlight-{{ annotation.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ annotation.Id }}';" tabindex="-1" aria-hidden="true">{{ new-highlighted }}</span>{{ suffix }}{% endcapture %}
            {% capture annotated-text-en %}{{ annotated-text-en | replace_first: replaced-text, new-text }}{% endcapture %}
            {% endunless %}
          {% else %}
            {% capture suffix %}{{ annotation.suffix | newline_to_br | split: "<br />" | first | rstrip | truncate: 5, "" }}{% endcapture %}
            {% capture replaced-text %}{{ highlighted }}{{ suffix }}{% endcapture %}
            {% comment %}{{ replaced-text }}<br>{% endcomment %}
            {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
            {% capture new-text %}<span id="highlight-{{ annotation.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ annotation.Id }}';" tabindex="-1" aria-hidden="true">{{ annotation.highlighted }}</span>{{ suffix }}{% endcapture %}
            {% capture annotated-text-en %}{{ annotated-text-en | replace_first: replaced-text, new-text }}{% endcapture %}
            {% endunless %}
          {% endif %}
        {% endfor %}
        
        {{ annotated-text-en }}
      </div>
      <div id="ru" markdown="1">
        {% capture annotated-text-ru %}
        {{ text_ru }}
        {% endcapture %}

        {% capture chapter-title-ru %}{% if page.number == "01" %}{{ page.number }}. ЗАИТИЛЫЦИНА{% else %}{{ page.number }}. {{ title_ru }}{% endif %}{% endcapture %}
        {% assign annotations-ru = site.data.comments-all | where: "chapter", chapter-title-ru %}
        {% for annotation in annotations-ru %}
          {% capture highlighted %}{{ annotation.highlighted }}{% endcapture %}
          {% assign thisIndex = forloop.index %}
          {% assign nestedAnnos = "" %}
          {% assign overlappedAnnos = "" %}
          {% for nextAnno in annotations-ru offset:thisIndex %}
            {% if nextAnno.position_start == annotation.position_start and nextAnno.position_end >= annotation.position_end %}
              {% assign nextIndex = forloop.index %}
              {% assign longerHighlighted = nextAnno.highlighted %}
              {% capture replaced-text %}{{ longerHighlighted }}{% endcapture %}
              {% capture new-text %}<span id="highlight-{{ nextAnno.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ nextAnno.Id }}';" tabindex="-1" aria-hidden="true">{{ longerHighlighted }}</span>{% endcapture %}
              {% capture annotated-text-ru %}{{ annotated-text-ru | replace_first: replaced-text, new-text }}{% endcapture %}
              {% assign highlighted = new-text %}
              {% for nextNextAnno in annotations-ru offset:nextIndex %}
                {% if nextNextAnno.position_start <= nextAnno.position_end and nextNextAnno.position_end <= nextAnno.position_end %}
                  {% capture nextId %}{{ nextNextAnno.Id }}, {% endcapture %}
                  {% assign nestedAnnos = nestedAnnos | append: nextId %}
                {% elsif nextNextAnno.position_start < nextAnno.position_end %}
                  {% continue %}
                {% else %}
                  {% break %}
                {% endif %}
              {% endfor %}
              {% if nestedAnnos != "" %}
                {% assign nestedAnnos = nestedAnnos | split: ", " %}
                {% assign replaced-highlighted = highlighted %}
                {% for nestedAnno in nestedAnnos %}
                  {% assign thisNestedAnno = annotations-ru | where: "Id", nestedAnno | first %}
                  {% capture new-highlighted %}<span id="highlight-{{ thisNestedAnno.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ thisNestedAnno.Id }}';" tabindex="-1" aria-hidden="true">{{ thisNestedAnno.highlighted }}</span>{% endcapture %}
                  {% capture replaced-highlighted %}{{ replaced-highlighted | replace_first: thisNestedAnno.highlighted, new-highlighted }}{% endcapture %}
                {% endfor %}
                {% capture replaced-text %}{{ highlighted }}{% endcapture %}
                {% capture new-text %}{{ replaced-highlighted }}{% endcapture %}
                {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
                {% capture annotated-text-ru %}{{ annotated-text-ru | replace_first: replaced-text, new-text }}{% endcapture %}
                {% endunless %}
              {% else %}
                {% capture suffix %}{{ annotation.suffix | newline_to_br | split: "<br />" | first | rstrip | truncate: 5, "" }}{% endcapture %}
                {% capture replaced-text %}{{ highlighted }}{{ suffix }}{% endcapture %}
                {% comment %}{{ replaced-text }}<br>{% endcomment %}
                {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
                {% capture new-text %}<span id="highlight-{{ annotation.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ annotation.Id }}';" tabindex="-1" aria-hidden="true">{{ annotation.highlighted }}</span>{{ suffix }}{% endcapture %}
                {% capture annotated-text-ru %}{{ annotated-text-ru | replace_first: replaced-text, new-text }}{% endcapture %}
                {% endunless %}
              {% endif %}
            {% elsif nextAnno.position_start <= annotation.position_end and nextAnno.position_end <= annotation.position_end %}
              {% capture nextId %}{{ nextAnno.Id }}, {% endcapture %}
              {% assign nestedAnnos = nestedAnnos | append: nextId %}
            {% elsif nextAnno.position_start < anno.position_end %}
               {% continue %}
            {% else %}
              {% break %}
            {% endif %}
          {% endfor %}
          {% if nestedAnnos != "" %}
            {% assign nestedAnnos = nestedAnnos | split: ", " %}
            {% for nestedAnno in nestedAnnos %}
              {% assign thisNestedAnno = annotations-ru | where: "Id", nestedAnno | first %}
              {% assign replaced-text = thisNestedAnno.highlighted %}
              {% capture new-text %}<span id="highlight-{{ thisNestedAnno.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ thisNestedAnno.Id }}';" tabindex="-1" aria-hidden="true">{{ thisNestedAnno.highlighted }}</span>{% endcapture %}
              {% capture new-highlighted %}{{ highlighted | replace_first: replaced-text, new-text }}{% endcapture %}
            {% endfor %}
            {% capture suffix %}{{ annotation.suffix | newline_to_br | split: "<br />" | first | rstrip | truncate: 5, "" }}{% endcapture %}
            {% capture replaced-text %}{{ highlighted }}{{ suffix }}{% endcapture %}
            {% comment %}{{ replaced-text }}<br>{% endcomment %}
            {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
            {% capture new-text %}<span id="highlight-{{ annotation.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ annotation.Id }}';" tabindex="-1" aria-hidden="true">{{ new-highlighted }}</span>{{ suffix }}{% endcapture %}
            {% capture annotated-text-ru %}{{ annotated-text-ru | replace_first: replaced-text, new-text }}{% endcapture %}
            {% endunless %}
          {% else %}
            {% capture suffix %}{{ annotation.suffix | newline_to_br | split: "<br />" | first | rstrip | truncate: 5, "" }}{% endcapture %}
            {% capture replaced-text %}{{ highlighted }}{{ suffix }}{% endcapture %}
            {% comment %}{{ replaced-text }}<br>{% endcomment %}
            {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
            {% capture new-text %}<span id="highlight-{{ annotation.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ annotation.Id }}';" tabindex="-1" aria-hidden="true">{{ annotation.highlighted }}</span>{{ suffix }}{% endcapture %}
            {% capture annotated-text-ru %}{{ annotated-text-ru | replace_first: replaced-text, new-text }}{% endcapture %}
            {% endunless %}
          {% endif %}
        {% endfor %}
        
        {{ annotated-text-ru }}
      </div>
    </div>
  </div>
</article>

{{ content }}
