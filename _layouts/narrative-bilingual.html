---
layout: bilingual
---

{% assign thisChapter = site.texts | where: "chapter-number", page.number %}
{% assign thisChapter-en = thisChapter | where: "language", "en" %}
{% for i in thisChapter-en %}
{% assign title_en = i.title %}
{% assign text_en = i.content %}
{% endfor %}
{% assign thisChapter-ru = thisChapter | where: "language", "ru" %}
{% for i in thisChapter-ru %}
{% assign title_ru = i.title %}
{% assign text_ru = i.content %}
{% endfor %}

<article class="narrative bilingual annotations-hidden" id="chapter-content">
  <div class="header">
    <h1 class="text-title" id="en-title">{{ page.number }}. {{ title_en }}</h1>
    <h1 class="text-title" id="ru-title">{{ page.number }}. {{ title_ru }}</h1>
    <h1 class="text-title" id="both-title">{{ page.number }}. {{ title_en }} / {{ title_ru }}</h1>
    <p class="byline">by {{ page.author }}</p>
    <p class="byline" id="translator">Translated by {{ page.translator }}</p>
  </div>

  <div class="main-content">
    <div class="text-container english" id="texts">
      <div id="en" markdown="1">
        {% capture annotated-text-en %}
        {{ text_en }}
        {% endcapture %}

        {% assign annotations-en = site.data.comments-all | where: "lang", "en" %}
        {% for annotation in annotations-en %}
            {% assign chapter = annotation.chapter | truncate: 2, "" %}
            {% if chapter == page.number %}
              {% capture highlighted %}{{ annotation.highlighted }}{% endcapture %}
              {% capture suffix %}{{ annotation.suffix | rstrip | truncate: 5, "" }}{% endcapture %}
              {% capture replaced-text %}{{ highlighted }}{{ suffix }}{% endcapture %}
              {% comment %}
              {{ replaced-text }}<br />
              <br />
              {% endcomment %}
              {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
              {% capture new-text %}<span id="highlight-{{ annotation.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ annotation.Id }}';" tabindex="-1" aria-hidden="true">{{ annotation.highlighted }}</span>{{ suffix }}{% endcapture %}
              {% capture annotated-text-en %}{{ annotated-text-en | replace_first: replaced-text, new-text }}{% endcapture %}
              {% endunless %}
            {% endif %}
        {% endfor %}
        
        {{ annotated-text-en }}
      </div>
      <div id="ru" markdown="1">
        {% capture annotated-text-ru %}
        {{ text_ru }}
        {% endcapture %}

        {% assign annotations-ru = site.data.comments-all | where: "lang", "ru" %}
        {% for annotation in annotations-ru %}
            {% assign chapter = annotation.chapter | truncate: 2, "" %}
            {% if chapter == page.number %}
              {% capture highlighted %}{{ annotation.highlighted }}{% endcapture %}
              {% capture suffix %}{{ annotation.suffix | rstrip | truncate: 5, "" }}{% endcapture %}
              {% capture replaced-text %}{{ highlighted }}{{ suffix }}{% endcapture %}
              {% comment %}
              {{ replaced-text }}<br />
              <br />
              {% endcomment %}
              {% unless replaced-text == "." %}  {% comment %} This is to prevent issues caused by the annotation of the last period of the chapter. {% endcomment %}
              {% capture new-text %}<span id="highlight-{{ annotation.Id }}" class="annotation-link" role="link" onclick="window.location.href='#{{ annotation.Id }}';" tabindex="-1" aria-hidden="true">{{ annotation.highlighted }}</span>{{ suffix }}{% endcapture %}
              {% capture annotated-text-ru %}{{ annotated-text-ru | replace_first: replaced-text, new-text }}{% endcapture %}
              {% endunless %}
            {% endif %}
        {% endfor %}
        
        {{ annotated-text-ru }}
      </div>
    </div>
  </div>
</article>

{{ content }}
